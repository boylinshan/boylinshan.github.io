---
layout: post
title: '任务系统-服务器端设计'
category: Work
---

# 服务器端

## 任务状态

在游戏中，任务共有一下六种状态：
1. 原始数据：任务数据尚存在于数据表中，由一个Dict存储。
2. 任务实例：Avatar初始化时，读取原始数据将其转变为TaskContext类的实例。
3. 可接受：对于满足条件的任务实例，保存下来并更新到可接受状态，此时任务已经会在客户端显示。
4. 运行中：玩家已经接受的任务，任务实例监控玩家的活动，满足条件时，转变为可完成状态。
5. 可完成：任务已经完成，等待玩家确认之后发放奖励。
6. 已完成：已经完成的任务。

## 任务流程

### 初始设计

*任务实例*--(**等级,前缀**)-->*可接受*--(**玩家点击接受**)-->*运行中* --(**具体类型决定**)-->*可完成*--(**玩家点击完成**)-->*已完成*

### 修改设计

目前对于任务流程的修改有两处，分别为自动接受以及自动完成。也就是跳过了客户端玩家点击确认的步骤。
目前问题在于，任务在进入到运行中状态时，即开始任务的执行，而此种情况会存在潜在的问题，目前主要为多个任务并行执行时的问题。

*任务实例*--(**等级,前缀**)-->*可接受*--(**服务器控制**)-->*运行中* --(**具体类型决定**)-->*可完成*--(**服务器控制**)-->*已完成*

## TaskContext类

### 基本构成

在游戏中每一个任务都由一个TaskContext实例表示。为了表示不同的任务状态，任务实例又可以分为不同的几个部分，每个部分代表不同状态下运行任务所触发的流程：
1. RegisterPart：用于在任务实例初始化后，判断当前任务时候可接受。任务系统在对任务表中数据遍历时，仅保留可接受的任务(已完成和运行中的任务已存储到数据库，由其他地方初始化)。
2. AcceptPart：任务处于可接受状态，运行时将判断玩家是否已经点击接受，若没有则将任务停留在此状态，等待玩家点击接受后，将任务置为运行中状态并将其加入到运行中任务列表。
3. RunPart：处于运行状态的任务由不同的Phase组成，运行时实际上将运行内部的Phase，当所有Phase完成后，将任务置为完成状态。
4. FinishPart：处于此状态的任务实质上已经完成，但若运行时玩家尚未确认，则停留在此状态， 待玩家确认后发放奖励并删除任务实例，将任务ID加入已完成任务列表，至此一个任务已经全部完成。
5. AutoAccpetPart：继承AcceptPart，取消玩家确认条件的限制，即进入此状态后任务将立刻进入运行中状态。
6. AutoFinishPart：继承FinishPart，取消玩家条件的限制，即进入此状态后任务将立刻尝试完成。

### 生命周期

![RPyC](/img/TaskContext.png)

任务在生命周期中状态情况可由上图表示，Register部分只负责判断任务实例是否保留，所以整个任务生命周期的开始实际上为AcceptPart。如图中所示，代表任务不同状态的几个部分存储在一个List当中，由一个index表示当前的状态，任务接到运行指令时，由index所指向的部分开始运行，依次向下直到某个Part无法完成，此时任务保存当前运行的进度，完成此次运行。

#### RegisterPart

##### 完成条件

1. 前缀不存在或前缀任务已完成


#### AcceptPart

##### 完成条件

1. 玩家等级在给定范围内。
2. 玩家点击了确认。

#### AutoAcceptPart

##### 完成条件

1. 玩家等级在给定范围内。

#### RunPart

##### 完成条件

1. 内部所有Phase均已完成。

#### FinishPart

##### 完成条件

1. 玩家点击了确认。
2. 奖励未发放(防止多次发放)。
3. 背包空间足够且额外背包未打开。


### RunPart

任务的主要流程都存在于RunPart中，因此详细介绍一下RunPart。RunPart结构与TaskContext类似，其内部维护了一个Phase列表。每个Phase应对玩家做任务时的每一环，整体的运行流程也与TaskConext类似。

![RPyC](/img/RunPart.png)

 任务中所产生的私人NPC，场景组件，信息记录以及与客户端的交互也都有具体的Phase处理，也就是说之前的部分构建了任务整体的框架，任务具体的表现由不同的Phase决定，在添加任务类别时，也即是增加新的Phase。目前有以下几个类别的Phase。

1. NpcTalkPhase：对话环节， 执行和NPC的一段对话，并选择正确的选项后完成。
2. KillMonsterPhase：需要击杀指定的怪物，到达指定数量后完成，目前为指定的某些怪物，后期需修改为某类怪物。
3. DetourPhase：寻路环节，执行一段寻路，寻路到执行目标点后完成。
4. HandEquipPhase：道具相关的一个环节，有获取和上交两个阶段，普通道具可跳过获取阶段。上交道具后完成。
5. PropertyUsePhase：场景道具使用环节，即任务中会出现图标的环节，原用于采集，现用于阴阳眼。图标使用后完成。
6. DungeonPhase：副本环节，将玩家传送到一个副本，由任务副本触发器标记完成，编辑器中配置。
7. MoviePhase：脚本动画环节，脚本动画播放后完成。
8. NpcEnterPhase：NPC进场，目前没接触过，UI表现相关。
9. UseComponentPhase：场景交互环节，玩家与场景中的组件进行交互（点击，击碎），满足指定数量后完成。
10. FinishDungeonPhase：日常副本环节，与之前副本环节的区别在于，此环节不指定副本，仅以副本胜利作为添加数量的标准，通过指定次数副本后完成。
11. BranchPhase：分支环节，满足分支任务的需求，根据玩家的选择执行不同的后续任务。因为当前任务的Phase是线性的，因此无法满足分支的需求。BranchPhase根据玩家的选择，在RunPart完成后，将需要执行的任务添加到当前TaskContext的状态列表中来改变后续的行为。

![RPyC](/img/BranchPhase.png)
